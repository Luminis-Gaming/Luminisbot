name: Build and Release Companion App

on:
  push:
    branches:
      - main
    paths:
      - 'companion_app/luminisbot_companion.py'  # Triggers when VERSION is changed
    tags:
      - 'v*.*.*'  # Also triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if VERSION changed
        id: check
        run: |
          # If triggered by tag, always release
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            VERSION="${{ github.ref_name }}"
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if VERSION line changed in the push
          if git diff HEAD^ HEAD -- companion_app/luminisbot_companion.py | grep -q "^+VERSION = "; then
            VERSION=$(grep -oP 'VERSION = "\K[^"]+' companion_app/luminisbot_companion.py)
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Version changed to: $VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "VERSION not changed, skipping release"
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          cd companion_app
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          cd companion_app
          python build_exe.py
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: pwsh
      
      - name: Build installer
        run: |
          cd companion_app
          $version = "${{ needs.check-version.outputs.version }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=$version installer.iss
        shell: pwsh
      
      - name: Self-sign executable and installer
        run: |
          # Create a self-signed certificate
          $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=Luminis Gaming, O=Luminis Gaming, C=NO" -CertStoreLocation Cert:\CurrentUser\My -NotAfter (Get-Date).AddYears(3)
          
          # Export certificate
          $pwd = ConvertTo-SecureString -String "temp" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath LuminisGaming.pfx -Password $pwd
          
          # Find signtool x64 version specifically
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe | Where-Object { $_.FullName -match "\\x64\\" } | Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signtool) {
            Write-Host "Warning: signtool not found, skipping signing"
            exit 0
          }
          
          Write-Host "Using signtool: $signtool"
          
          # Sign the executable
          & $signtool sign /f LuminisGaming.pfx /p temp /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 companion_app\dist\LuminisbotCompanion.exe
          
          # Sign the installer
          $installerPath = Get-ChildItem companion_app\installer -Filter *.exe | Select-Object -First 1 -ExpandProperty FullName
          if ($installerPath) {
            & $signtool sign /f LuminisGaming.pfx /p temp /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $installerPath
            Write-Host "Successfully signed installer"
          }
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Warning: Failed to sign files, continuing anyway..."
          } else {
            Write-Host "Successfully signed executable and installer"
          }
        shell: pwsh
        continue-on-error: true
      
      - name: Get version
        id: get_version
        run: |
          $version = "${{ needs.check-version.outputs.version }}"
          $tag = "v$version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create or update tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f v${{ steps.get_version.outputs.VERSION }} -m "Release version ${{ steps.get_version.outputs.VERSION }}"
          git push -f origin v${{ steps.get_version.outputs.VERSION }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            companion_app/dist/LuminisbotCompanion.exe
            companion_app/installer/*.exe
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Luminisbot Companion v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Luminisbot Companion v${{ steps.get_version.outputs.VERSION }}
            
            ### Installation Options
            
            **Option 1: Windows Installer (Recommended)**
            - Download: `LuminisbotCompanion-Setup-v${{ steps.get_version.outputs.VERSION }}.exe`
            - Features: Start Menu shortcut, Add/Remove Programs, optional auto-start
            - Best for most users
            
            **Option 2: Portable Executable**
            - Download: `LuminisbotCompanion.exe`
            - No installation required - run directly
            - Best for portable/USB use
            
            ### Auto-Updates
            This version includes auto-update functionality. Future updates will be automatically detected.
            
            ### Changes
            See the commit history for details on what's new in this release.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
